{
  "hash": "2bb3f2886b07c78ab548a95e4dee0122",
  "result": {
    "engine": "knitr",
    "markdown": "---\nexname: tidymodels2\nextype: string\nexsolution: NA\ncategories:\n- ds1\n- tidymodels\n- prediction\n- yacsda\n- statlearning\n- error\n- string\ndate: '2023-05-17'\nslug: tidymodels2\ntitle: tidymodels2\n\n---\n\n\n\n\n\n\n\n\n# Aufgabe\n\nEin merkwürdiger Fehler bzw. eine merkwürdige Fehlermeldung in Tidymodels -\ndas untersuchen wir hier genauer und versuchen das Phänomen zu erklären.\n\n\n\n\n*Aufgabe*\n\nErläutern Sie die Ursachen des Fehlers!\nSchalten Sie den Fehler an und ab,\num zu zeigen,\ndass Sie Ihn verstehen.\n\n\n\n\n# Startup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\n```\n:::\n\n\n\n\n# Data import\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"mtcars\")\n\nd_train <- mtcars %>% slice_head(n = 20)\nd_test <- mtcars %>% slice(21:n())\n```\n:::\n\n\n\n\n\n# Recipe\n\n\n::: {.cell}\n\n```{.r .cell-code}\npreds_chosen <- c(\"hp\", \"disp\", \"am\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec1 <- \n  recipe( ~ ., data = d_train) %>% \n  update_role(all_predictors(), new_role = \"id\") %>% \n  update_role(all_of(preds_chosen), new_role = \"predictor\") %>% \n  update_role(mpg, new_role = \"outcome\")\nrec1\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Recipe ──────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Inputs \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNumber of variables by role\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\noutcome:   1\npredictor: 3\nid:        7\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nd_train_baked <-\n  rec1 %>% \n  prep() %>% \n  bake(new_data = NULL)\n\nglimpse(d_train_baked)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 20\nColumns: 11\n$ mpg  <dbl> 21.0, 21.0, 22.8, 21.4, 18.7, 18.1, 14.3, 24.4, 22.8, 19.2, 17.8,…\n$ cyl  <dbl> 6, 6, 4, 6, 8, 6, 8, 4, 4, 6, 6, 8, 8, 8, 8, 8, 8, 4, 4, 4\n$ disp <dbl> 160.0, 160.0, 108.0, 258.0, 360.0, 225.0, 360.0, 146.7, 140.8, 16…\n$ hp   <dbl> 110, 110, 93, 110, 175, 105, 245, 62, 95, 123, 123, 180, 180, 180…\n$ drat <dbl> 3.90, 3.90, 3.85, 3.08, 3.15, 2.76, 3.21, 3.69, 3.92, 3.92, 3.92,…\n$ wt   <dbl> 2.620, 2.875, 2.320, 3.215, 3.440, 3.460, 3.570, 3.190, 3.150, 3.…\n$ qsec <dbl> 16.46, 17.02, 18.61, 19.44, 17.02, 20.22, 15.84, 20.00, 22.90, 18…\n$ vs   <dbl> 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1\n$ am   <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1\n$ gear <dbl> 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 4, 4, 4\n$ carb <dbl> 4, 4, 1, 1, 2, 1, 4, 2, 2, 4, 4, 3, 3, 3, 4, 4, 4, 1, 2, 1\n```\n\n\n:::\n:::\n\n\n\n\n\n\n# Model 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_lm <- linear_reg()\n```\n:::\n\n\n\n# Workflow 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwf1 <-\n  workflow() %>% \n  add_model(model_lm) %>% \n  add_recipe(rec1)\n```\n:::\n\n\n\n\n\n#  Fit\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_fit1 <-\n  wf1 %>% \n  fit(d_train)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npreds <-\n  lm_fit1 %>% \n  predict(d_test)\n\nhead(preds)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 1\n  .pred\n  <dbl>\n1  22.6\n2  17.2\n3  17.4\n4  12.1\n5  14.9\n6  28.2\n```\n\n\n:::\n:::\n\n\n\nAus Gründen der Reproduzierbarkeit bietet es sich an, eine `SessionInfo` anzugeben:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.2.1 (2022-06-23)\nPlatform: x86_64-apple-darwin17.0 (64-bit)\nRunning under: macOS Big Sur ... 10.16\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib\nLAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] yardstick_1.2.0    workflowsets_1.0.1 workflows_1.1.3    tune_1.1.2        \n [5] rsample_1.2.0      recipes_1.0.8      parsnip_1.1.1      modeldata_1.2.0   \n [9] infer_1.0.5        dials_1.2.0        scales_1.2.1       broom_1.0.5       \n[13] tidymodels_1.1.1   lubridate_1.9.3    forcats_1.0.0      stringr_1.5.0     \n[17] dplyr_1.1.3        purrr_1.0.2        readr_2.1.4        tidyr_1.3.0       \n[21] tibble_3.2.1       ggplot2_3.4.4      tidyverse_2.0.0    colorout_1.3-0    \n\nloaded via a namespace (and not attached):\n [1] foreach_1.5.2       jsonlite_1.8.7      splines_4.2.1      \n [4] prodlim_2023.03.31  GPfit_1.0-8         yaml_2.3.7         \n [7] globals_0.16.2      ipred_0.9-14        pillar_1.9.0       \n[10] backports_1.4.1     lattice_0.21-8      glue_1.6.2         \n[13] digest_0.6.33       hardhat_1.3.0       colorspace_2.1-0   \n[16] htmltools_0.5.6.1   Matrix_1.5-4.1      timeDate_4022.108  \n[19] pkgconfig_2.0.3     lhs_1.1.6           DiceDesign_1.9     \n[22] listenv_0.9.0       gower_1.0.1         lava_1.7.2.1       \n[25] tzdb_0.4.0          timechange_0.2.0    generics_0.1.3     \n[28] ellipsis_0.3.2      withr_2.5.2         furrr_0.3.1        \n[31] nnet_7.3-19         cli_3.6.1           survival_3.5-5     \n[34] magrittr_2.0.3      evaluate_0.21       fansi_1.0.5        \n[37] future_1.33.0       parallelly_1.36.0   MASS_7.3-60        \n[40] class_7.3-22        tools_4.2.1         data.table_1.14.8  \n[43] hms_1.1.3           lifecycle_1.0.3     munsell_0.5.0      \n[46] compiler_4.2.1      rlang_1.1.1         grid_4.2.1         \n[49] iterators_1.0.14    rstudioapi_0.15.0   htmlwidgets_1.6.2  \n[52] rmarkdown_2.25      gtable_0.3.4        codetools_0.2-19   \n[55] R6_2.5.1            knitr_1.45          fastmap_1.1.1      \n[58] future.apply_1.11.0 utf8_1.2.3          stringi_1.7.12     \n[61] parallel_4.2.1      Rcpp_1.0.11         vctrs_0.6.4        \n[64] rpart_4.1.19        tidyselect_1.2.0    xfun_0.40          \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n</br>\n</br>\n</br>\n</br>\n</br>\n</br>\n</br>\n</br>\n</br>\n</br>\n\n# Lösung\n\n\nDefiniert man das Rezept so:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrec2 <- recipe(mpg ~ hp + disp + am, data = d_train)\n```\n:::\n\n\nDann läuft `predict()` brav durch.\n\n\nAuch dieser Code funktioniert:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrec3 <- \n  recipe(mpg ~ ., data = d_train) %>% \n  update_role(all_predictors(), new_role = \"id\") %>% \n  update_role(all_of(preds_chosen), new_role = \"predictor\") %>% \n  update_role(mpg, new_role = \"outcome\")\n```\n:::\n\n\n\n\nDas Problem von `rec1` scheint darin zu legen,\ndass die *Rollen* der Variablen nicht richtig gelöscht werden,\nwas `predict()` verwirrt:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrec1 <- \n  recipe(mpg ~ ., data = d_train) %>% \n  update_role(all_predictors(), new_role = \"id\") %>% \n  update_role(all_of(preds_chosen), new_role = \"predictor\") %>% \n  update_role(mpg, new_role = \"outcome\")\nrec1\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Recipe ──────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Inputs \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNumber of variables by role\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\noutcome:   1\npredictor: 3\nid:        7\n```\n\n\n:::\n:::\n\n\n\nDaher läuft das Rezept `rec3` durch,\nwenn man zunächst alle Prädiktoren in ID-Variablen umwandelt: Damit\nsind alle Rollen wieder sauber.\n\n\n\n\n\n---\n\nCategories: \n\n- ds1\n- tidymodels\n- prediction\n- yacsda\n- statlearning\n- error\n- string\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}